# Лабораторная работа 2. Многотабличные запросы и подготовка данных

## Цель работы
Освоить методы объединения таблиц (`JOIN`, `UNION`), работу с подзапросами и функции преобразования данных (`CASE`, `COALESCE`) в PostgreSQL.

**Основано на:**
*   Chapter 3. SQL for Data Preparation


---

## Часть 1. Общие задания (Guided Labs)

Выполните эти задания для тренировки. Код и скриншоты добавьте в отчет.

### Задание 2.1. Поиск покупателей авто (INNER JOIN)
**Бизнес-задача.** Получить контактные данные всех клиентов, купивших автомобиль, для обзвона.
**Требование:**
*   Использовать таблицу `sales`, `customers`, `products`.
*   Условие: `product_type` = 'automobile'.
*   Условие: `phone` is not null.
*   Вывести: `customer_id`, `first_name`, `last_name`, `phone`.

### Задание 2.2. Вечеринка в Лос-Анджелесе (UNION)
**Бизнес-задача.** Составить список приглашенных на мероприятие. Это клиенты И сотрудники из Лос-Анджелеса.
**Требование:**
*   Запрос 1: Клиенты из `city` = 'Los Angeles'.
*   Запрос 2: Продавцы (`salespeople`), работающие в дилерских центрах (`dealerships`) в `city` = 'Los Angeles'.
*   Объединить через `UNION`.
*   Добавить поле `guest_type` ('Customer' или 'Employee').

### Задание 2.3. Создание витрины данных (Data Transformation)
**Бизнес-задача.** Подготовить "плоскую" таблицу для аналитиков данных.
**Требование:**
1.  Соединить `sales` (основа), `customers`, `products`, `dealerships` (Left Join).
2.  Очистить данные:
    *   Если `dealership_id` в продажах NULL, заменить на -1 (используйте `COALESCE`).
3.  Создать признак (Feature Engineering):
    *   Столбец `high_savings`: равен 1, если (`base_msrp` - `sales_amount`) > 500. Иначе 0.

---

## Часть 2. Индивидуальные задания

Выберите вариант `(Номер в списке % 30) + 1`.

| # | Задание 1 (JOIN) | Задание 2 (Subquery/Union) | Задание 3 (Functions) |
|---|---|---|---|
| **1** | Продажи в штате 'CA' (модель, дата). | Клиенты, купившие то же, что и ID=1. | `products`: цена <500 'Low', >2000 'High'. |
| **2** | Продавцы и адреса их дилерских центров. | Города клиентов UNION Города дилеров. | `customers`: если нет телефона -> 'No Phone'. |
| **3** | Детали продаж (имя, модель, цена, дата). | Товары дороже среднего (Subquery). | `sales`: сезон (Зима, Весна...) по дате. |
| **4** | Продажи товаров типа 'scooter'. | Продавцы в штате 'NY' (Subquery). | `customers`: full_name, cast index to int. |
| **5** | Email клиентов и темы писем. | Продукты, которые не продавались (NOT IN). | `sales`: dealer_id NULL -> 'Online' else 'Offline'. |
| **6** | Города дилеров и сотрудники-мужчины. | Имена клиентов UNION Имена сотрудников. | Скидка в %. Обработка деления на 0. |
| **7** | Модель товара и штат клиента. | Клиенты из штата дилера ID=5. | `suffix`: NULL заменить на 'N/A'. |
| **8** | Продажи со штатом дилера (Inner Join). | Товары дороже самого дешевого авто. | Клиенты 'Local' (NY) и 'Non-Local'. |
| **9** | Клиенты, кликнувшие по ссылке (JOIN emails). | Уникальные города дилеров и клиентов. | `products`: "Model Year: [year]". |
| **10** | Продажи 'Model Chi' с именами. | Сотрудники, нанятые после увольнения старейшего. | `dealerships`: date_closed -> 'Still Open'. |
| **11** | Товары, проданные в 'FL' (дата произв). | Клиенты без покупок (LEFT JOIN check). | Стаж продавца: 'Junior'/'Senior'. |
| **12** | Продавцы и их штаты (сорт. по штату). | Все индексы (zip) клиентов и дилеров. | `products`: is_vintage (год < 2015). |
| **13** | Сумма и базовая цена за 2019 год. | Клиенты, купившие 'automobile'. | `ip_address`: NULL -> 'Unknown'. |
| **14** | Клиенты и дата отправки писем. | Дилеры без сотрудников. | Разница цены. Отрицательные -> 0 (`GREATEST`). |
| **15** | Интернет-продажи (модель, цена). | UNION ALL ID дилеров из sales и dealerships. | Сумма продажи: Small/Medium/Large. |
| **16** | Сотрудники и должности в 'Houston'. | Товары с максимальной ценой. | Первая буква фамилии + email. |
| **17** | Клиенты и дата последней покупки. | Клиенты 'TX', не покупавшие 'scooter'. | Lat/Long -> в целые числа (`::int`). |
| **18** | Продажи (штат клиента == штат дилера). | Сотрудники дилеров, открытых до 2010. | `title`: NULL -> 'Sales Associate'. |
| **19** | Клиенты и дата открытия писем. | Продукты, купленные в 'NYC'. | contact: тел или email (`COALESCE`). |
| **20** | Модели и кол-во продаж (или список). | Список всех штатов (клиенты + дилеры). | `products`: снят с пр-ва (дата не null). |
| **21** | Продажи дилера ID=10. | Клиенты с покупкой > 50k. | Дата транзакции -> только дата (`::DATE`). |
| **22** | Продавцы, пол и штат офиса. | Товары, проданные только в 2018. | `gender`: NULL -> 'Not Specified'. |
| **23** | Клиенты и модели их скутеров. | Клиенты: есть письмо, нет покупок. | Налог 10% от продажи, округлить. |
| **24** | Продажи со скидкой > 10%. | Сотрудники (город работы == город жительства). | Latitude: >40 'North', else 'South'. |
| **25** | Открытые письма и имена клиентов. | UNION моделей и типов продуктов. | Адрес: 'Apt' -> 'Apartment'. |
| **26** | Сотрудники в штате 'NV'. | Самый дорогой товар в интернете. | Строка "Model: X (Year: Y)". |
| **27** | Даты продаж товара 'Lemon'. | Дилеры без клиентов в своем штате. | `sales_amount`: NULL -> 0. |
| **28** | Клиенты товаров до 2015 года. | Все уникальные zip-коды (все таблицы). | Статус клиента: VIP (>50k) / Regular. |
| **29** | Продавцы в 'Austin' (дата найма). | Клиенты (купил авто И скутер). | Уволен: Дата или 'Active'. |
| **30** | Транзакции клиентов с суффиксом 'Jr.'. | Самый дешевый проданный товар. | `emails`: clicked -> 'Interested'. |

---

## Требования к отчету

1.  Создайте файл `README.md` в папке `lab_02`.
2.  Вставьте условие задач вашего варианта.
3.  Вставьте SQL код решения.
4.  Вставьте скриншот результата (таблицы).
5.  Загрузите файл `lab_02.sql` с кодом.
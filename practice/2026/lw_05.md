# Лабораторная работа №5. SQL для подготовки данных

**СУБД:** PostgreSQL  
**Источник данных:** `bi_sql_data_student_dump.sql`

## 1. Цель работы
Научиться собирать данные из нескольких таблиц в единый набор данных (dataset) и применять функции очистки и трансформации данных для подготовки их к дальнейшему анализу.

## 2. Задачи
1. Изучить способы объединения таблиц с помощью операторов `JOIN` (INNER, LEFT, RIGHT, FULL, CROSS).
2. Научиться объединять результаты запросов с помощью `UNION` и `UNION ALL`.
3. Освоить функции условной логики и обработки NULL-значений: `CASE WHEN`, `COALESCE`, `NULLIF`.
4. Применить функции нормализации данных: `LEAST`/`GREATEST`, приведение типов (`CAST`), удаление дубликатов (`DISTINCT`).
5. Выполнить практические задания по формированию аналитических витрин данных.

## 3. Теоретическая часть

В аналитике до 80% времени занимает подготовка данных. Данные редко хранятся в одной таблице в готовом виде. Основные этапы подготовки включают сборку (Assembling) и трансформацию (Transforming).

### 3.1. Объединение таблиц (JOINS)
Для соединения таблиц используется ключевое слово `JOIN` в сочетании с условием `ON` (предикатом соединения).

*   **INNER JOIN**. Возвращает только те строки, для которых найдено совпадение в обеих таблицах.
*   **LEFT OUTER JOIN**. Возвращает все строки из левой таблицы. Если совпадение в правой таблице не найдено, столбцы правой таблицы заполняются значениями `NULL`.
*   **RIGHT OUTER JOIN**. Аналогично LEFT, но сохраняются все строки из правой таблицы.
*   **FULL OUTER JOIN**. Возвращает строки, если есть совпадение хотя бы в одной из таблиц (объединение множеств).
*   **CROSS JOIN**. Декартово произведение — каждая строка первой таблицы соединяется с каждой строкой второй таблицы.

### 3.2. Объединение запросов (UNIONS)
Позволяет объединить результаты двух и более запросов «вертикально» (добавить строки).
*   **UNION**. Объединяет результаты и **удаляет дубликаты**.
*   **UNION ALL**. Объединяет результаты, сохраняя все строки (включая дубликаты). Работает быстрее.
*   *Требование.* Количество и типы столбцов в объединяемых запросах должны совпадать.

### 3.3. Трансформация и очистка
*   **CASE WHEN**. Позволяет реализовать логику «ЕСЛИ-ТО-ИНАЧЕ» внутри запроса.
*   **COALESCE(val1, val2, ...)**. Возвращает первое **не-NULL** значение из списка. Идеально для замены пропусков (например, `COALESCE(phone, 'Не указан')`).
*   **NULLIF(val1, val2)**. Возвращает `NULL`, если `val1` равно `val2`. Полезно для предотвращения деления на ноль.
*   **LEAST / GREATEST**. Выбирает минимальное или максимальное значение из списка аргументов (построчно).
*   **DISTINCT**. Удаляет дублирующиеся строки из результата.
*   **DISTINCT ON (col)**. Оставляет только первую строку для каждого уникального значения указанного столбца (важен порядок `ORDER BY`).

## 4. Практическая часть (Общие задания)

Для выполнения заданий необходимо развернуть базу данных из дампа `bi_sql_data_student_dump.sql`.

### Задание 4.1. Сборка данных о продажах (JOIN)
**Задача.** Менеджеру требуется отчет о проданных автомобилях (имя клиента, модель, цена, дата).

**Решение:**
```sql
SELECT
    c.first_name,
    c.last_name,
    p.model,
    s.sales_amount,
    s.sales_transaction_date
FROM sales s
INNER JOIN customers c ON s.customer_id = c.customer_id
INNER JOIN products p ON s.product_id = p.product_id
WHERE p.product_type = 'automobile'
ORDER BY s.sales_transaction_date DESC
LIMIT 10;
```

### Задание 4.2. Список всех городов присутствия (UNION)
**Задача:** Составить единый список уникальных названий городов (клиенты + дилеры).

**Решение.**
```sql
SELECT city, 'Client City' as type FROM customers
UNION
SELECT city, 'Dealership City' as type FROM dealerships
ORDER BY city;
```

### Задание 4.3. Очистка данных и категоризация (Transformation)
**Задача.** Вывести список клиентов. Обработать пустые телефоны, добавить регион (West/East/Other).

**Решение:**
```sql
SELECT
    first_name,
    last_name,
    COALESCE(phone, 'No Phone') as contact_phone,
    CASE
        WHEN state IN ('CA', 'WA') THEN 'West'
        WHEN state IN ('NY', 'FL') THEN 'East'
        ELSE 'Other'
    END as region
FROM customers
LIMIT 20;
```

## 5. Индивидуальные задания

[Варианты заданий на образовательном портале](https://envlab.ru/mod/assign/view.php?id=1053)

## 6. Требования к оформлению и сдаче

1.  **Репозиторий:**
    *   Работа выполняется в личном репозитории на GitHub.
    *   Создайте папку `lab_05`.
2.  **Файлы:**
    *   `README.md`. Отчет о выполнении. Должен содержать:
        *   Номер варианта.
        *   Текст 3-х индивидуальных заданий.
        *   SQL-код решений.
        *   **Скриншот результата** (первые 10-15 строк) из DBeaver/pgAdmin.
    *   `lab_05.sql`. Скрипт со всеми запросами подряд.
3.  **Сдача.** Ссылка на репозиторий в Moodle.
4.  **База данных:**
    *   Задания выполняются на основе дампа `bi_sql_data_student_dump.sql` (ссылка: [https://disk.yandex.ru/d/yJTa_s86xpbpMQ](https://disk.yandex.ru/d/yJTa_s86xpbpMQ)).

## 7. Критерии оценки

*   **5 баллов (Отлично).** Выполнены все общие и индивидуальные задания. Код работает верно, отчет содержит скриншоты и пояснения.
*   **4 балла (Хорошо).** Выполнены все задания, но есть мелкие ошибки в типах JOIN или сортировке. Отчет присутствует.
*   **3 балла (Удовлетворительно).** Выполнены только общие задания или индивидуальные задания с грубыми ошибками (использование декартова произведения вместо JOIN).

```

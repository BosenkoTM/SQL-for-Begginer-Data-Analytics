# Лабораторная работа 5. Оптимизация запросов с помощью индексов и анализа плана выполнения

**СУБД:** PostgreSQL  
**Источник данных:** `bi_sql_data_student_dump.sql` (Основной источник Глава 8. Performant SQL)


## Цель работы
Научиться анализировать производительность SQL-запросов, интерпретировать план выполнения (Query Plan) и оптимизировать работу базы данных с помощью различных типов индексов (B-tree, Hash).

## Задачи
1.  Изучить принципы работы планировщика запросов (Query Planner) в PostgreSQL.
2.  Освоить команды `EXPLAIN` и `EXPLAIN ANALYZE` для диагностики производительности.
3.  Сравнить методы сканирования таблиц: последовательное сканирование (Sequential Scan) и сканирование по индексу (Index Scan).
4.  Научиться создавать и применять индексы для ускорения выборок.
5.  **Важно.** Понять разницу между выполнением запросов на чтение (в промышленной среде) и оптимизацией (в среде разработки).

---

## ⚠️ Важно. Разделение сред выполнения

В данной лабораторной работе критически важно соблюдать регламент работы с серверами. Операции создания индексов (`CREATE INDEX`) являются ресурсоемкими и изменяют структуру БД, поэтому они **запрещены** на основном учебном сервере.

| Тип задания | Среда выполнения | Примечание |
| :--- | :--- | :--- |
| **Задание 1 (Анализ плана)** | **Основной сервер** | Выдается преподавателем. Права только на чтение. Здесь вы оцениваете "медленный" запрос. |
| **Задания 2* и 3* (Оптимизация)** | **Локально** | Требуют прав `CREATE`. Необходимо развернуть свою БД или использовать [VM (devops_dba_25.ova)](https://envlab.ru/mod/url/view.php?id=303). |

---

## Теоретическая часть

### Планирование запросов (Query Planning)
Перед выполнением любого SQL-запроса СУБД строит **план выполнения**. Планировщик выбирает наиболее эффективный способ извлечения данных, основываясь на статистике.

*   **`EXPLAIN query`** — показывает предполагаемый план *без* выполнения запроса.
*   **`EXPLAIN ANALYZE query`** — *выполняет* запрос и показывает реальное время выполнения (Execution Time) и стоимость (Cost).

### Стоимость (Cost)
В выводе `EXPLAIN` параметры выглядят так: `cost=0.00..123.45`.
*   `0.00` — затраты на старт (получение первой строки).
*   `123.45` — общие затраты на получение всех строк.

### Методы сканирования
1.  **Sequential Scan (Seq Scan).** Полный перебор строк таблицы. Используется, когда индексов нет или нужно прочитать большую часть таблицы. Это "медленный" метод для точечных запросов.
2.  **Index Scan / Bitmap Heap Scan.** Использование индекса для быстрого поиска. Эффективен для выборки малого количества строк.

### Типы индексов
*   **B-Tree.** Стандартный индекс. Подходит для сравнений (`<`, `=`, `>`), сортировки (`ORDER BY`) и диапазонов.
*   **Hash.** Подходит только для точного равенства (`=`).

---

## Практическая часть (Пример выполнения)

### Шаг 1. Анализ текущей производительности (Основной сервер)
Требуется найти клиентов из штата Калифорния. Выполняем на сервере преподавателя:

```sql
EXPLAIN ANALYZE
SELECT * FROM customers WHERE state = 'CA';
```

**Результат (пример):**
```text
Seq Scan on customers  (cost=0.00..1536.00 rows=50 width=144)
  Filter: (state = 'CA'::text)
Execution Time: 15.2 ms
```
*Вывод.* Используется `Seq Scan` (полный перебор), время 15.2 мс.

### Шаг 2. Оптимизация (Локальная среда)
Переходим в локальную базу данных (где развернут тот же дамп).

1.  **Создаем индекс:**
    ```sql
    CREATE INDEX idx_customers_state ON customers(state);
    ```
2.  **Повторяем анализ:**
    ```sql
    EXPLAIN ANALYZE
    SELECT * FROM customers WHERE state = 'CA';
    ```

**Результат (пример):**
```text
Bitmap Heap Scan on customers ...
  ->  Bitmap Index Scan on idx_customers_state ...
Execution Time: 1.5 ms
```
*Вывод.* Время сократилось в 10 раз, используется индекс.

3.  **Очистка (Локально):**
    ```sql
    DROP INDEX idx_customers_state;
    ```

---

## Индивидуальные задания

Выберите вариант `(Номер в списке % 30) + 1`.

*   **Задание 1.** Выполнить `EXPLAIN ANALYZE` на **Основном сервере**. Зафиксировать план (Seq Scan) и время.
*   **Задание 2*.** Выполнить тот же запрос **Локально**, создать индекс (B-Tree или Hash), проверить ускорение.
*   **Задание 3*.** Выполнить оптимизацию сложного запроса **Локально**.

| Вариант | Задание 1 (Анализ на сервере) + Задание 2* (Индекс локально) | Задание 3* (Сложная оптимизация локально - JOIN/Range) |
|:---:|:---|:---|
| **1** | Найти клиентов (`customers`) c `gender = 'F'`. (Индекс B-Tree) | Оптимизировать поиск продаж (`sales`) по `dealership_id` = 5. |
| **2** | Найти товары (`products`) типа `product_type = 'scooter'`. (Индекс B-Tree) | Оптимизировать поиск клиентов с `postal_code` = '33111'. |
| **3** | Найти продажи (`sales`) с суммой `sales_amount = 0`. (Индекс B-Tree) | Оптимизировать выборку товаров (`products`) с `year` = 2015. |
| **4** | Найти письма (`emails`) со статусом `opened = 't'`. (Индекс Hash) | Оптимизировать поиск продаж (`sales`) за конкретную дату `sales_transaction_date`. |
| **5** | Найти сотрудников (`salespeople`) с именем `first_name = 'William'`. (Индекс B-Tree) | Оптимизировать JOIN `sales` и `products` по `product_id`. |
| **6** | Найти дилеров (`dealerships`) в штате `state = 'TX'`. (Индекс B-Tree) | Оптимизировать поиск клиентов по `email` (уникальный поиск). |
| **7** | Найти продукты (`products`) модели `model = 'Lemon'`. (Индекс Hash) | Оптимизировать поиск продаж по `channel = 'internet'`. |
| **8** | Найти клиентов (`customers`) из города `city = 'New York City'`. (Индекс B-Tree) | Оптимизировать выборку продаж с суммой > 1000. |
| **9** | Найти продажи (`sales`) по каналу `channel = 'dealership'`. (Индекс B-Tree) | Оптимизировать поиск сотрудников (`salespeople`) по `hire_date` (диапазон). |
| **10** | Найти клиентов (`customers`) с фамилией `last_name = 'Smith'`. (Индекс B-Tree) | Оптимизировать поиск дилеров, закрытых (`date_closed` IS NOT NULL). |
| **11** | Найти письма (`emails`), которые были `clicked = 't'`. (Индекс Hash) | Оптимизировать поиск товаров (`products`) дороже 5000 (`base_msrp`). |
| **12** | Найти продажи (`sales`) для товара с `product_id = 10`. (Индекс B-Tree) | Оптимизировать поиск клиентов, зарегистрированных (`date_added`) в 2018 году. |
| **13** | Найти сотрудников (`salespeople`) с должностью `title = 'Sales Associate'`. (Индекс B-Tree) | Оптимизировать JOIN `sales` и `customers` по `customer_id`. |
| **14** | Найти дилеров (`dealerships`), открытых (`date_opened`) конкретно '2010-01-01'. (Индекс B-Tree) | Оптимизировать поиск писем по теме `email_subject` (точное совпадение). |
| **15** | Найти товары (`products`) с базовой ценой `base_msrp = 599.99`. (Индекс B-Tree) | Оптимизировать поиск продаж для конкретного дилера (`dealership_id`). |
| **16** | Найти клиентов (`customers`) с `suffix = 'Jr'`. (Индекс B-Tree) | Оптимизировать поиск продуктов, произведенных в диапазоне дат. |
| **17** | Найти продажи (`sales`), где `sales_amount` < 100. (Индекс B-Tree) | Оптимизировать поиск клиентов по `ip_address`. |
| **18** | Найти письма (`emails`), отправленные (`sent_date`) '2015-01-01'. (Индекс B-Tree) | Оптимизировать JOIN `salespeople` и `dealerships` по `dealership_id`. |
| **19** | Найти продукты (`products`) типа `product_type = 'automobile'`. (Индекс Hash) | Оптимизировать поиск клиентов с широтой (`latitude`) > 40. |
| **20** | Найти клиентов (`customers`) с `gender = 'M'`. (Индекс B-Tree) | Оптимизировать поиск продаж с `sales_amount` между 1000 и 2000. |
| **21** | Найти дилеров (`dealerships`) с почтовым индексом `postal_code = '90210'`. (Индекс B-Tree) | Оптимизировать поиск сотрудников по `username`. |
| **22** | Найти продажи (`sales`) с `product_id = 5`. (Индекс B-Tree) | Оптимизировать выборку писем, которые `bounced = 't'`. |
| **23** | Найти клиентов (`customers`) c `title = 'Dr'`. (Индекс B-Tree) | Оптимизировать поиск товаров, у которых `production_end_date` IS NULL. |
| **24** | Найти сотрудников (`salespeople`) в дилерском центре `dealership_id = 7`. (Индекс B-Tree) | Оптимизировать поиск продаж за последний месяц (по дате транзакции). |
| **25** | Найти товары (`products`) с годом выпуска `year = 2019`. (Индекс B-Tree) | Оптимизировать поиск клиентов по номеру телефона (`phone`). |
| **26** | Найти письма (`emails`) по `customer_id = 100`. (Индекс B-Tree) | Оптимизировать поиск дилеров в городе 'Houston'. |
| **27** | Найти продажи (`sales`), где `dealership_id` IS NULL. (Индекс B-Tree) | Оптимизировать JOIN `emails` и `customers` по `customer_id`. |
| **28** | Найти клиентов (`customers`) в штате `state = 'FL'`. (Индекс Hash) | Оптимизировать поиск продуктов с ценой `base_msrp` < 50. |
| **29** | Найти сотрудников (`salespeople`) мужского пола (`gender='M'`). (Индекс B-Tree) | Оптимизировать поиск продаж по `sales_transaction_date` (диапазон). |
| **30** | Найти дилеров (`dealerships`) по индексу `postal_code = '10001'`. (Индекс B-Tree) | Оптимизировать поиск клиентов с именем `first_name` на букву 'A' (LIKE 'A%'). |

---

## Правила оформления отчета

1.  **Репозиторий.** Работа загружается в папку `lab_05` вашего репозитория.
2.  **Файл `README.md`:** Должен содержать отчет по структуре:
    *   **Вариант №X**
    *   **Задание 1 (Сервер):**
        *   Текст запроса.
        *   Скриншот плана (`Seq Scan`).
        *   Указание стоимости (Cost) и времени (Time).
    *   **Задание 2* (Локально):**
        *   Команда создания индекса.
        *   Скриншот нового плана (`Index Scan` / `Bitmap Scan`).
        *   **Сравнение:** "Время выполнения уменьшилось с X мс до Y мс".
    *   **Задание 3* (Локально):** Аналогично: запрос -> создание индекса -> новый план.
3.  **Скрипт.** Файл `lab_05.sql` с SQL-командами.
4.  **Сдача.** Ссылка на репозиторий в Moodle.

## Критерии оценки

*   **3 балла.** Выполнено только Задание 1 (анализ на основном сервере без оптимизации) или Задания 1 и 2 выполнены, но без доказательств локального создания индексов.
*   **4 балла.** Выполнены Задания 1 и 2*. Представлены скриншоты "До" (с сервера) и "После" (локально с индексом).
*   **5 баллов.** Выполнены все 3 задания (включая сложное). Отчет содержит грамотный анализ того, почему планировщик выбрал индекс (снижение Cost).
```


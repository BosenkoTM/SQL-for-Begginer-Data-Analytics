## Тест 1. Основы SQL и анализ данных

### Блок 1. Основы SQL (SELECT, WHERE, ORDER BY)

**Задание 1.**
Отдел маркетинга хочет выделить премиальный сегмент скутеров.
Напишите SQL-запрос к таблице `products`. Выберите поля `model`, `base_msrp` и `year`.
Оставьте только товары с типом (`product_type`) **'scooter'** и ценой (`base_msrp`) выше **500**.
Отсортируйте результат по цене от большей к меньшей.

**Задание 2.**
Необходимо найти все работающие дилерские центры в штате Техас.
Напишите запрос к таблице `dealerships`. Выведите `dealership_id`, `city` и `date_opened`.
Условия фильтрации: штат (`state`) равен **'TX'** и дата закрытия (`date_closed`) не заполнена (является `NULL`).
Сортировка по ID дилера.

**Задание 3.**
HR-отдел запрашивает список сотрудников, нанятых в 2018 году, для проведения аттестации.
Напишите запрос к таблице `salespeople`. Выведите `first_name`, `last_name` и `hire_date`.
Условие: дата найма (`hire_date`) находится в диапазоне с **'2018-01-01'** по **'2018-12-31'**.
Отсортируйте список по фамилии в алфавитном порядке.

**Задание 4.**
Нужно получить список женщин-клиентов, проживающих в штате Нью-Йорк или Нью-Джерси.
Напишите запрос к таблице `customers`. Выведите `first_name`, `last_name`, `state`.
Условия: `gender` = **'F'** и `state` входит в список **('NY', 'NJ')**.
Отсортируйте по штату, затем по фамилии.
Ограничьте вывод первыми 10 записями.

**Задание 5.**
Анализ бюджетного сегмента.
Напишите запрос к таблице `products`. Выведите `model` и `base_msrp`.
Условия: тип продукта (`product_type`) — **'automobile'**, цена (`base_msrp`) меньше **40000**.
Сортировка по возрастанию цены.

**Задание 6.**
Анализ эффективности онлайн-канала.
Напишите запрос к таблице `sales`. Выведите все поля (`*`).
Условие: канал продаж (`channel`) равен **'internet'** и сумма продажи (`sales_amount`) находится в диапазоне от **500** до **600** (включительно).
Ограничьте вывод первыми 20 записями.

**Задание 7.**
Нужно почистить базу рассылки. Найдите письма, которые вернулись с ошибкой в **2013 году**.
Напишите запрос к таблице `emails`. Выведите `email_id`, `customer_id` и `sent_date`.
Условия:
1. Флаг возврата (`bounced`) равен **'t'** (true).
2. Дата отправки (`sent_date`) попадает в период с 1 января 2013 года по 31 декабря 2013 года включительно.
Сортировка по дате отправки (от новых к старым). При совпадении даты сортируйте по ID письма (по возрастанию).

**Задание 8.**
Какие модели техники были выпущены в 2016 году?
Напишите запрос к таблице `products`. Выведите только уникальные названия моделей (`model`).
Условие: год выпуска (`year`) равен **2016**.

**Задание 9.**
Отделу сервиса нужны клиенты, с которыми можно связаться только по почте.
Напишите запрос к таблице `customers`. Выведите `customer_id`, `email`.
Условия:
1. Поле `phone` является пустым (`NULL`).
2. Поле `email` заполнено (`IS NOT NULL`).
3. Идентификатор клиента (`customer_id`) должен быть **меньше 100** (состоять не более чем из 2 цифр).

**Задание 10.**
Найдите крупные продажи, совершенные через дилерские центры (не интернет).
Напишите запрос к таблице `sales`. Выведите `sales_transaction_date`, `sales_amount`, `dealership_id`.
Условия: `channel` = **'dealership'** и `sales_amount` > **1000**.
Сортировка по сумме продажи, затем по дате транзакции по убыванию.
Ограничьте вывод 20 первыми записями.

---

### Блок 2. Соединения таблиц (JOIN) и функции

**Задание 11.**
Составьте отчет о продажах автомобилей, подтянув названия моделей.
Используйте таблицы `sales` и `products`.
Выведите: `s.sales_transaction_date`, `p.model`, `s.sales_amount`.
Условие соединения: `product_id`.
Фильтр: только для `p.product_type` = **'automobile'**.
Сортировка: по дате продажи.
Ограничьте вывод первыми 10 записями.

**Задание 12.**
Маркетинг хочет знать, какие темы писем получали конкретные клиенты.
Используйте таблицы `customers` и `emails`.
Выведите: `c.first_name`, `c.last_name`, `e.email_subject`.
Используйте `INNER JOIN`.
Отсортируйте по фамилии клиента.
Ограничьте вывод первыми 10 записями.

**Задание 13.**
В каком штате была совершена продажа?
Используйте таблицы `sales` и `dealerships`.
Выведите: `s.sales_amount`, `d.city`, `d.state`.
Условие: `sales.channel` = **'dealership'**.
Сортировка по штату, затем по городу.
Ограничьте вывод первыми 10 записями.

**Задание 14.**
Вывести список сотрудников с указанием города, где они работают.
Используйте таблицы `salespeople` и `dealerships`.
Выведите: `salespeople.first_name`, `salespeople.last_name`, `dealerships.city`.
Условие: только для дилеров из штата **'CA'**.
Сортировка по фамилии сотрудника.
Ограничьте вывод первыми 10 записями.

**Задание 15.**
Нужно получить контактные данные покупателей скутеров модели 'Lemon'.
Используйте таблицы `sales`, `products`, `customers`.
Выведите: `c.first_name`, `c.last_name`, `c.phone`.
Условия: `p.model` = **'Lemon'** и `p.product_type` = **'scooter'**.
Исключите дубликаты строк, если один клиент купил несколько раз (используйте `DISTINCT`).
Сортировка по фамилии клиента.
Ограничьте вывод первыми 10 записями.

**Задание 16.**
Насколько цена продажи отличается от базовой цены (скидки)?
Используйте таблицы `sales` и `products`.
Выведите: `p.model`, `p.base_msrp`, `s.sales_amount`, и вычисляемое поле `discount` (разница между `base_msrp` и `sales_amount`).
Условие: только продажи 2017 года (`s.sales_transaction_date` между '2017-01-01' и '2017-12-31').
Сортировка по дате транзакции.
Ограничьте вывод первыми 10 записями.

**Задание 17.**
Подготовьте список адресов для рассылки. Если адрес (`street_address`) не указан, выведите 'Unknown'.
Используйте таблицу `customers`.
Выведите: `first_name`, `last_name`, и поле с адресом, обработанное функцией `COALESCE(street_address, 'Unknown')` как `address_fixed`.
Сортировка по фамилии.
Ограничьте вывод первыми 10 записями.

**Задание 18.**
Разделите продажи на категории: 'Low' (< 500), 'Medium' (500-1000), 'High' (> 1000).
Используйте таблицу `sales`.
Выведите: `sales_transaction_date`, `sales_amount` и вычисляемое поле `price_category` (используя `CASE WHEN`).
Сортировка по сумме продажи.
Ограничьте вывод первыми 10 записями.

**Задание 19.**
Найдите продажи, где клиент и дилер находятся в одном и том же штате.
Используйте `sales`, `customers`, `dealerships`.
Выведите: `sales.sales_transaction_date`, `customers.state` (как `cust_state`), `dealerships.state` (как `deal_state`).
Условие соединения: `s.customer_id = c.customer_id` и `s.dealership_id = d.dealership_id`.
Фильтр: `c.state = d.state`.
Сортировка по дате транзакции.
Ограничьте вывод первыми 10 записями.

**Задание 20.**
Есть ли модели 2019 года, которые еще ни разу не были проданы?
Используйте `products` (левая таблица) и `sales`.
Выведите: `p.model`, `p.year`.
Условие: `p.year` = 2019 и `sales.sales_transaction_date` IS NULL (т.е. нет соответствия в таблице продаж).
Сортировка по модели.
Ограничьте вывод первыми 10 записями.

---

### Блок 3. Агрегация и Группировка (GROUP BY, HAVING)

**Задание 21.**
Рассчитайте минимальную, максимальную и среднюю базовую цену для каждого типа продукции.
Используйте таблицу `products`.
Выведите: `product_type`, `MIN(base_msrp)`, `MAX(base_msrp)`, `AVG(base_msrp)`.
Группировка по `product_type`.

**Задание 22.**
Где живет больше всего наших клиентов?
Используйте таблицу `customers`.
Выведите: `state` и количество клиентов (`count_cust`).
Группировка по `state`.
Сортировка по убыванию количества (`count_cust DESC`).
Исключите записи, где штат не указан (`NULL`).

**Задание 23.**
Какой канал продаж приносит больше всего денег?
Используйте таблицу `sales`.
Выведите: `channel` и сумму продаж (`total_sales` = сумма `sales_amount`).
Группировка по `channel`.

**Задание 24.**
Найдите дилеров, которые совершили более 50 продаж.
Используйте таблицу `sales`.
Выведите: `dealership_id` и количество продаж (`sales_count`).
Группировка по `dealership_id`.
Фильтрация результата (`HAVING`): количество > 50.
Сортировка по убыванию количества.

**Задание 25.**
Как меняется средняя сумма транзакции по годам?
Используйте таблицу `sales`.
Выведите: Год продажи (используйте `EXTRACT(YEAR FROM sales_transaction_date)`) и среднюю сумму (`avg_amount`).
Группировка по году.
Сортировка по году.

**Задание 26.**
Какие модели продаются чаще всего?
Используйте `sales` и `products`.
Выведите: `p.model` и количество продаж.
Группировка по `p.model`.
Выведите топ-5 моделей.

**Задание 27.**
Посчитайте, сколько мужчин и женщин работает в каждом дилерском центре.
Используйте таблицу `salespeople`.
Выведите: `dealership_id`, `gender` и количество сотрудников.
Группировка по двум полям: `dealership_id`, `gender`.
Сортировка по `dealership_id`.

**Задание 28.**
Аналитики хотят найти типы продуктов, где цена сильно варьируется.
Используйте таблицу `products`.
Выведите: `product_type` и стандартное отклонение цены (`STDDEV(base_msrp)`).
Группировка по `product_type`.
Оставьте только те группы, где стандартное отклонение больше 50.

**Задание 29.**
Найдите дилеров, которые принесли суммарную выручку более полумиллиона.
Используйте таблицу `sales`.
Выведите: `dealership_id` и сумму `sales_amount`.
Условие: `dealership_id` не должен быть NULL.
Группировка по `dealership_id`.
Фильтр `HAVING`: сумма > 500000.

**Задание 30.**
Какие темы писем (`email_subject`) открывают чаще всего?
Используйте таблицу `emails`.
Выведите: `email_subject` и количество открытых писем (где `opened`='t').
Группировка по `email_subject`.
Сортировка по количеству открытий (по убыванию).

---

### Блок 4. Дополнительные и комплексные задания (31-40)

**Задание 31.**
Вывести дату продажи, сумму и название модели продукта (`model`) для всех продаж. Использовать `JOIN` таблиц `sales` и `products`.
Выведите поля: `sales_transaction_date`, `sales_amount`, `model`.
Сортировка по дате.
Ограничьте вывод первыми 10 записями.

**Задание 32.**
Вывести имена (`first_name`) и фамилии (`last_name`) клиентов, которые купили товар с типом 'automobile'.
Убрать дубликаты (`DISTINCT`).
Используйте `JOIN` таблиц `customers`, `sales`, `products`.
Сортировка по фамилии.
Ограничьте вывод первыми 10 записями.

**Задание 33.**
Вывести имя сотрудника (`first_name`) и город (`city`), в котором находится его дилерский центр.
Используйте `JOIN` таблиц `salespeople` и `dealerships`.
Сортировка по городу, затем по имени сотрудника.
Ограничьте вывод первыми 10 записями.

**Задание 34.**
Найти все продажи (сумма и дата), совершенные дилерами из штата 'NY'.
Выведите: `sales_amount`, `sales_transaction_date`.
Используйте `JOIN` таблиц `sales` и `dealerships`.
Сортировка по дате транзакции.
Ограничьте вывод первыми 10 записями.

**Задание 35.**
Найти клиентов (id и фамилия), у которых нет записей в таблице продаж.
Вывести: `c.customer_id`, `c.last_name`.
Используйте `LEFT JOIN` и проверку на `NULL`.
Вывести первые 10 записей, отсортированных по ID.

**Задание 36.**
Вывести уникальные email клиентов, купивших 'scooter'.
Используйте `JOIN` таблиц `customers`, `sales`, `products`.
Сортировка по email.
Ограничьте вывод первыми 10 записями.

**Задание 37.**
Вывести название города дилера (`city`) и количество работающих там сотрудников.
Используйте `JOIN` таблиц `dealerships` и `salespeople`.
Сгруппировать по городу. Сортировка по количеству сотрудников (по убыванию), затем по городу.
Ограничьте вывод первыми 10 записями.

**Задание 38.**
Вывести имя клиента (`first_name`) и общую сумму его покупок (`total_spent`).
Сгруппировать по клиенту.
Отсортировать по сумме по убыванию.
Вывести **топ-5** клиентов.

**Задание 39.**
Вывести названия моделей (`model`), которые продавались через канал 'internet'.
Значения должны быть уникальными.
Используйте `JOIN` таблиц `products` и `sales`.
Сортировка по модели.
Ограничьте вывод первыми 10 записями.

**Задание 40.**
Вывести уникальные имена (`first_name`) и фамилии (`last_name`) клиентов, которые открыли хотя бы одно письмо (`opened`='t').
Используйте `JOIN` таблиц `customers` и `emails`.
Сортировка по фамилии.
Ограничьте вывод первыми 10 записями.